<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="Workflows | vamp.io">
        
        <meta property="og:url" content="http://vamp.io/documentation/using-vamp/workflows/">
        <meta property="og:image" content="http://vamp.io/img/vamp_logo_blue_circle.png">
        <meta property="og:site_name" content="Vamp.io">
        
            
                <meta name="description" content="Workflows A &ldquo;workflow&rdquo; is an automated change of the running system and its deployments. Changing number of running instances based on metrics (e.g. SLA) is an example of a workflow. A workflow can be seen as a recipe or solution, however it has more generic meaning not just related to a &ldquo;problematic&rdquo; situation. Another example is a workflow that will decide automatically if a new version, when doing a canary release, should be accepted or not.">           
                <meta property="og:description" content="Workflows A &ldquo;workflow&rdquo; is an automated change of the running system and its deployments. Changing number of running instances based on metrics (e.g. SLA) is an example of a workflow. A workflow can be seen as a recipe or solution, however it has more generic meaning not just related to a &ldquo;problematic&rdquo; situation. Another example is a workflow that will decide automatically if a new version, when doing a canary release, should be accepted or not.">           
                <meta property="twitter:description" content="Workflows A &ldquo;workflow&rdquo; is an automated change of the running system and its deployments. Changing number of running instances based on metrics (e.g. SLA) is an example of a workflow. A workflow can be seen as a recipe or solution, however it has more generic meaning not just related to a &ldquo;problematic&rdquo; situation. Another example is a workflow that will decide automatically if a new version, when doing a canary release, should be accepted or not.">           
            
                            
        
        <meta property="twitter:site" content="vamp.io">
        <meta property="twitter:title" content="Workflows | vamp.io">
        <meta property="twitter:image" content="http://vamp.io/img/vamp_logo_blue.png">        
        <meta property="twitter:creator" content="vamp.io">    
        <meta property="twitter:url" content="http://vamp.io/documentation/using-vamp/workflows/">    
        <meta property="twitter:card" content="summary">    
        <title>Workflows - documentation -  Vamp :: The Very Awesome Microservices Platform</title>
        <link rel="stylesheet" href="http://vamp.io/vendor/theme/flat-ui/bootstrap/css/bootstrap.css">
        <link rel="stylesheet" href="http://vamp.io/css/flat-ui.min.css">
        <link rel="stylesheet" href="http://vamp.io/vendor/theme/common-files/css/icon-font.css">
        <link rel="stylesheet" href="http://vamp.io/vendor/theme/common-files/css/animations.css">
        <link rel="stylesheet" href="http://vamp.io/css/ui.min.css" >
        <link rel="icon" type="image/png" sizes="192x192"  href="http://vamp.io/img/favicon-192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="http://vamp.io/img/favicon-32.png">

        
        <script type="text/javascript">(function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
        for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);
    mixpanel.init("3dc73f826819c8e11d0d9898ca4291c8");</script>
        
    </head>
<body>
<div class="page-wrapper">

<header class="header-3">
    <div class="container">
        <div class="row">
            <div class="navbar col-sm-12" role="navigation">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle"></button>
                    <a class="logo" href="http://vamp.io/"><img src="http://vamp.io/img/vamp_logo_blue_circle.svg" alt="vamp"></a>
                    <span id="alpha">alpha</span>
                </div>
                <div class="collapse navbar-collapse pull-right">
                    <ul class="nav pull-left">
                        <li><a href="http://vamp.io/documentation/">WHAT IS VAMP?</a></li>
                        <li><a href="http://vamp.io/quick-start/">QUICK START</a></li>
                        <li><a href="http://vamp.io/documentation/">DOCS</a></li>
                        <li><a href="http://vamp.io/blog/">BLOG</a></li>
                        <li><a href="https://github.com/magneticio/vamp/" target="_blank">GITHUB</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="header-background"></div>
</header>
<section class="subheader">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                
                <h4>documentation
                
                
            </div>
        </div>
    </div>
</section>

<section class="content-wrapper">
    <div class="container">
        <div class="row">
            <div class="col-md-2">
                

<aside>
    <div id="sidenav">
        
        <ul class="sidenav-menu top-level">
            
                        
                        
            <li class="sub-menu">                 
            <a href="http://vamp.io/documentation" data-target=".collapse_about-vamp" class="sub-menu-header collapsed" data-toggle="collapse">
                
                <span>About Vamp</span>                
            </a>
            <ul class="collapse_about-vamp sub collapse ">
                
                <li>
                <a href="http://vamp.io/documentation" class="sub-menu-link"> What is Vamp?
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/about-vamp/service-discovery/" class="sub-menu-link"> Service discovery
                </a>
                </li>                
                
            </ul>
            
            </li>
                        
                        
            <li class="sub-menu">                 
            <a href="http://vamp.io/installation/" data-target=".collapse_installation" class="sub-menu-header collapsed" data-toggle="collapse">
                
                <span>Installing Vamp</span>                
            </a>
            <ul class="collapse_installation sub collapse ">
                
                <li>
                <a href="http://vamp.io/installation" class="sub-menu-link"> Components
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/installation/container_drivers/" class="sub-menu-link"> Container drivers
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/installation/configuration/" class="sub-menu-link"> Configuration
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/installation/installation/" class="sub-menu-link"> Installation details
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/installation/quick_start/" class="sub-menu-link"> Quick start Marathon
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/installation/osx" class="sub-menu-link"> Mac OS X
                </a>
                </li>                
                
            </ul>
            
            </li>
                        
                        
            <li class="sub-menu active ">                 
            <a href="http://vamp.io/documentation/using-vamp/" data-target=".collapse_using-vamp" class="sub-menu-header collapsed" data-toggle="collapse">
                
                <span>Using Vamp</span>                
            </a>
            <ul class="collapse_using-vamp sub collapse  in ">
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/" class="sub-menu-link"> Using Vamp
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/breeds/" class="sub-menu-link"> Breeds
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/blueprints/" class="sub-menu-link"> Blueprints
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/deployments/" class="sub-menu-link"> Deployments
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/gateways/" class="sub-menu-link"> Gateways
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/environment_variables/" class="sub-menu-link"> Environment variables
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/routings-and-filters/" class="sub-menu-link"> Routing &amp; filters
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/metrics-and-events/" class="sub-menu-link"> Metrics &amp; Events
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/sla-and-escalations/" class="sub-menu-link"> SLA &amp; escalations
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/references/" class="sub-menu-link"> Referencing artefacts
                </a>
                </li>                
                
                <li class="active">
                <a href="http://vamp.io/documentation/using-vamp/workflows/" class="sub-menu-link"> Workflows
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/using-vamp/sticky-sessions/" class="sub-menu-link"> Sticky Sessions
                </a>
                </li>                
                
            </ul>
            
            </li>
                        
                        
            <li class="sub-menu">                 
            <a href="http://vamp.io/documentation/guides/" data-target=".collapse_guides" class="sub-menu-header collapsed" data-toggle="collapse">
                
                <span>Guides</span>                
            </a>
            <ul class="collapse_guides sub collapse ">
                
                <li>
                <a href="http://vamp.io/documentation/guides/" class="sub-menu-link"> Getting started tutorial
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/guides/getting-started-tutorial/1-deploying/" class="sub-menu-link"> 1. Deploying a blueprint
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/guides/getting-started-tutorial/2-canary-release/" class="sub-menu-link"> 2. Doing a canary release
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/guides/getting-started-tutorial/3-splitting-services/" class="sub-menu-link"> 3. Splitting into services
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/guides/getting-started-tutorial/4-merge-delete/" class="sub-menu-link"> 4. Merging and deleting services
                </a>
                </li>                
                
            </ul>
            
            </li>
                        
                        
            <li class="sub-menu">                 
            <a href="http://vamp.io/documentation/api-reference/" data-target=".collapse_api-reference" class="sub-menu-header collapsed" data-toggle="collapse">
                
                <span>API reference</span>                
            </a>
            <ul class="collapse_api-reference sub collapse ">
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/" class="sub-menu-link"> Overview
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/breeds/" class="sub-menu-link"> Breeds
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/blueprints/" class="sub-menu-link"> Blueprints
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/deployments/" class="sub-menu-link"> Deployments
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/gateways/" class="sub-menu-link"> Gateways
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/scales/" class="sub-menu-link"> Scales
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/filters/" class="sub-menu-link"> Filters
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/slas/" class="sub-menu-link"> Slas
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/escalations/" class="sub-menu-link"> Escalations
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/metrics-events/" class="sub-menu-link"> Events
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/api-reference/debug/" class="sub-menu-link"> Debug
                </a>
                </li>                
                
            </ul>
            
            </li>
                        
                        
            <li class="sub-menu">                 
            <a href="http://vamp.io/documentation/cli-reference/" data-target=".collapse_cli-reference" class="sub-menu-header collapsed" data-toggle="collapse">
                
                <span>CLI reference</span>                
            </a>
            <ul class="collapse_cli-reference sub collapse ">
                
                <li>
                <a href="http://vamp.io/documentation/cli-reference/" class="sub-menu-link"> Overview
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/cli-reference/installation/" class="sub-menu-link"> Installation &amp; config
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/cli-reference/commands/" class="sub-menu-link"> Commands
                </a>
                </li>                
                
            </ul>
            
            </li>
                        
                        
            <li class="sub-menu">                 
            <a href="http://vamp.io/documentation/community/" data-target=".collapse_community" class="sub-menu-header collapsed" data-toggle="collapse">
                
                <span>Community</span>                
            </a>
            <ul class="collapse_community sub collapse ">
                
                <li>
                <a href="http://vamp.io/documentation/community/" class="sub-menu-link"> Issues &amp; Support
                </a>
                </li>                
                
                <li>
                <a href="http://vamp.io/documentation/community/contribute/" class="sub-menu-link"> Contribute to Vamp
                </a>
                </li>                
                
            </ul>
            
            </li>
                        
            
            <li>
                <a href="http://vamp.io/faq">
                    
                    <span>FAQ</span>
                </a>
                
            </li>
            
        </ul>
        
    </div>
</aside>

            </div>
            <div class="col-md-9 docs">
                

<h1 id="workflows:fb1fa01592006b281b5dab056da87dae">Workflows</h1>

<p>A &ldquo;workflow&rdquo; is an automated change of the running system and its deployments. Changing number of running instances based on metrics (e.g. SLA) is an example of a workflow. A workflow can be seen as a recipe or solution, however it has more generic meaning not just related to a &ldquo;problematic&rdquo; situation.</p>

<p>Another example is a workflow that will decide automatically if a new version, when doing a canary release, should be accepted or not. For instance, push the route up to 50% of traffic to the new version, compare metrics over some time (e.g. frequency of 5xx errors, response time), change to 100% and remove the old version. This workflow could define the rate of the transitions (e.g. 5% -&gt; 10% -&gt; 25%, &hellip;) as well.</p>

<h2 id="rationale:fb1fa01592006b281b5dab056da87dae">Rationale</h2>

<p>Workflows allow closing the feedback loop: deploy, measure, <strong>react</strong>.
Vamp workflows are based on scripting - scripting allows experimentation with different features and if the feature is common and generic enough, it could be supported later in DSL itself.</p>

<h2 id="workflow-api:fb1fa01592006b281b5dab056da87dae">Workflow API</h2>

<ul>
<li><p>Each workflow is represented as an artifact and they follow basic CRUD operation patterns as any other artifact:</p>

<pre><code>/api/v1/workflows
</code></pre></li>

<li><p>Scheduled workflow are artifacts consisted of an embedded or reference workflow and its trigger (time or event based):</p>

<pre><code>/api/v1/scheduled-workflows
</code></pre></li>
</ul>

<h3 id="scripting:fb1fa01592006b281b5dab056da87dae">Scripting</h3>

<p>Workflow example:</p>

<pre><code class="language-yaml"># Name of the workflow, mandatory.
name: logger

# Optional script to be included before the execution of the main script.
import:
- http://underscorejs.org/underscore-min.js # External (http) script.
- vamp.js                                   # Reference to another 
                                            # workflow (by name).

# Optional variables expected to be set before the execution.
requires:
- deployment
- cluster

# Script.
script: log.info(&quot;hi&quot;)
</code></pre>

<p>Scheduled workflow example:</p>

<pre><code class="language-yaml"># Mandatory name of the scheduling.
name: logger-schedule

# Triggers can be deployment (created, updated or deleted), 
# event and time based. Precedence of triggers: 
# deployment, time and then event based.

# Example of deployment trigger with specified deployment id:
deployment: 9e67a7eb-cb64-45f5-b619-fbad179afe5a

# Example of time (CRON) trigger:
time: 15 9 5 1

# Event based trigger - if any Vamp event matches specified tags, 
# workflow will be triggered.
tags:
- deployment
- cluster

# Optional script to be included before the execution.
import:
- http://underscorejs.org/underscore-min.js
- vamp.js

# Either reference to the workflow (by name)
workflow: logger
# or embedded script if no workflow is referenced.
script: log.debug(&quot;hi there!&quot;)

</code></pre>

<h3 id="features:fb1fa01592006b281b5dab056da87dae">Features</h3>

<ul>
<li>Support for JavaScript only scripts - other languages may be supported later.</li>

<li><p>Script has access to its trigger data:</p>

<ul>
<li>deployment trigger, &ldquo;tags&rdquo; and &ldquo;deployment&rdquo;</li>
<li>time trigger - &ldquo;timestamp&rdquo;, Unix epoch</li>
<li>event trigger - &ldquo;tags&rdquo;
<code>javascript
_.each(tags, function(tag){ log.info(tag); }); 
</code></li>
</ul></li>

<li><p>Script has restricted access to Java API and <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/scripting/nashorn/">Nashorn</a> additional functions (e.g. exit).</p></li>

<li><p>Support for local storage (keeping data between executions):</p></li>
</ul>

<pre><code class="language-yaml">---
name: counter-schedule
time: &quot;*/3 * * * * ?&quot;
storage:
  counter: 0

script: |
  var counter = storage.get(&quot;counter&quot;);
  log.info(counter);
  storage.put(&quot;counter&quot;, ++counter);

  log.info(storage.getOrElse(&quot;message&quot;, &quot;Hello World!&quot;));
</code></pre>

<h4 id="logging-api:fb1fa01592006b281b5dab056da87dae">Logging API</h4>

<ul>
<li>debug, info, warn, error:</li>
</ul>

<pre><code class="language-javascript">  log.error(&quot;alert!&quot;);
</code></pre>

<h4 id="info-api:fb1fa01592006b281b5dab056da87dae">Info API</h4>

<pre><code class="language-javascript">  log.info(vamp.info().message); // logs Vamp Hi message
</code></pre>

<h4 id="event-api:fb1fa01592006b281b5dab056da87dae">Event API</h4>

<ul>
<li>add: tag(String)</li>
<li>add type: type(String)</li>
<li>add value: value(AnyRef)</li>
<li>publish event: publish()</li>
<li>time range: lt(String), lte(String), gt(String), gte(String)</li>
<li>query (get all): query()</li>
<li>aggregation: count(), max(), min(), average()/avg(), sum()</li>
<li>reset all parameters: reset()</li>
</ul>

<pre><code class="language-javascript">  events.tag(&quot;deployments&quot;).publish();
</code></pre>

<pre><code class="language-javascript">  events.tag(&quot;deployments&quot;).gt(&quot;now() - 10m&quot;).count();
</code></pre>

<pre><code class="language-javascript">  var list = events.tag(&quot;servers&quot;).tag(&quot;services&quot;).query();
  // Requires underscore.js
  _.each(list, function(event){ 
    _.each(event.tags, function(tag){ log.info(tag); });
  });
</code></pre>

<pre><code class="language-javascript">  /* response time is nested object
  {
    &quot;tags&quot;: [
      &quot;services&quot;,
      &quot;servers&quot;,
      &quot;metrics&quot;
    ],
    &quot;value&quot;: {
        &quot;response&quot;: {
            &quot;time&quot;: 15
        }
    },
    &quot;timestamp&quot;: &quot;2015-06-05T15:12:38.000Z&quot;,
    &quot;type&quot;: &quot;router-metric&quot;
  }
  */
  // set tags
  events.tag(&quot;servers&quot;).tag(&quot;services&quot;)
  // log average value of complex type field.
  log.info(events.field(&quot;response.time&quot;).average());
</code></pre>

<h4 id="vamp-rest-api:fb1fa01592006b281b5dab056da87dae">Vamp REST API</h4>

<p>Artifacts: breeds, blueprints, slas, scales, escalations, routings, filters, workflows, scheduled_workflows:</p>

<ul>
<li>all() - get all (paginated internally, problem with large data set)</li>
<li>create(artifacts) - create an artifact</li>
<li>update(artifacts)</li>
<li>delete(artifacts)</li>
</ul>

<pre><code class="language-javascript">  function listBreeds(title) {
    log.info(title);
    var list = breeds.all();
    for (var i = 0; i &lt; list.length; i++) {
      log.info(list[i].name + &quot; -&gt; &quot; + list[i].deployable);
    }
  }

  listBreeds(&quot;Before:&quot;);

  // create a new breed
  var breed = {};
  breed.name = &quot;sava&quot;;
  breed.deployable = &quot;vamp/sava:1.0.0&quot;;
  breeds.create(breed);

  listBreeds(&quot;After creation:&quot;);

  // update
  breed.deployable = &quot;vamp/sava:1.1.0&quot;;
  breeds.update(breed);

  listBreeds(&quot;After update:&quot;);

  // delete
  breed = breeds.get(&quot;sava&quot;); // 'get' example
  breeds.delete(breed);

  listBreeds(&quot;After deletion:&quot;);
</code></pre>

<p>Deployments:</p>

<ul>
<li>all() - get all (paginated internally, problem with large data set)</li>
<li>create(blueprint) - create a deployment</li>
<li>update(name, blueprint) - update deployment (partial update)</li>
<li>delete(name, blueprint) - delete deployment (or partial update)</li>
</ul>

<p>Example of the simple canary release - on each sequential call stage is incremented starting from 0:</p>

<span>
    <button class="copy-button pull-right btn" data-clipboard-text="---
name: canary
time: &quot;*/30 * * * * ?&quot;

storage:
  counter: 0

script: |
  var stage = storage.getOrElse(&quot;stage&quot;, 0);

  if(stage == 0) { 
    // create breeds, just to use them as reference
    breeds.create({
      &quot;name&quot;: &quot;sava:1.0.0&quot;,
      &quot;deployable&quot;: &quot;docker://magneticio/sava:1.0.0&quot;,
      &quot;ports&quot;: {
        &quot;port&quot;: &quot;8080/http&quot;
      }
    });
    breeds.create({
      &quot;name&quot;: &quot;sava:1.1.0&quot;,
      &quot;deployable&quot;: &quot;docker://magneticio/sava:1.1.0&quot;,
      &quot;ports&quot;: {
        &quot;port&quot;: &quot;8080/http&quot;
      }
    });

    // deploy the 1.0.0 service
    var deployment = deployments.create({
      &quot;name&quot;: &quot;sava&quot;,
      &quot;gateways&quot;: {
        &quot;9050/http&quot;: &quot;sava/port&quot;
      },
      &quot;clusters&quot;: {
        &quot;sava&quot;: {
          &quot;services&quot;: [
            {
              &quot;breed&quot;: &quot;sava:1.0.0&quot;
            }
          ]
        }
      }
    });
    storage.put(&quot;deployment&quot;, deployment.name);
  } else if(stage == 1) { // deploy the 1.1.0 service
    deployments.update(storage.get(&quot;deployment&quot;), {
      &quot;name&quot;: &quot;sava&quot;,
      &quot;clusters&quot;: {
        &quot;sava&quot;: {
          &quot;services&quot;: [
            {
              &quot;breed&quot;: &quot;sava:1.1.0&quot;
            }
          ]
        }
      }
    });
  } else if(stage == 2) { // adjust weight of services
    deployments.update(storage.get(&quot;deployment&quot;), {
      &quot;name&quot;: &quot;sava&quot;,
      &quot;clusters&quot;: {
        &quot;sava&quot;: {
          &quot;services&quot;: [
            {
              &quot;breed&quot;: &quot;sava:1.0.0&quot;,
            },
            {
              &quot;breed&quot;: &quot;sava:1.1.0&quot;,
            }
          ],
          &quot;routing&quot;: {
            &quot;routes&quot;: {
              &quot;sava:1.0.0&quot;: {
                &quot;weight&quot;: &quot;0%&quot;
              },
              &quot;sava:1.1.0&quot;: {
                &quot;weight&quot;: &quot;100%&quot;
              }
            }
          }
        }
      }
    });
  } else if(stage == 3) { // delete the 1.0.0
    deployments.delete(storage.get(&quot;deployment&quot;), {
      &quot;name&quot;: &quot;sava&quot;,
      &quot;clusters&quot;: {
        &quot;sava&quot;: {
          &quot;services&quot;: [
            {
              &quot;breed&quot;: &quot;sava:1.0.0&quot;
            }
          ]
        }
      }
    });
  }
  
  storage.put(&quot;stage&quot;, &#43;&#43;stage);

" data-toggle="tooltip">
        Copy
    </button>
<pre><code class="language-yaml">---
name: canary
time: &quot;*/30 * * * * ?&quot;

storage:
  counter: 0

script: |
  var stage = storage.getOrElse(&quot;stage&quot;, 0);

  if(stage == 0) { 
    // create breeds, just to use them as reference
    breeds.create({
      &quot;name&quot;: &quot;sava:1.0.0&quot;,
      &quot;deployable&quot;: &quot;docker://magneticio/sava:1.0.0&quot;,
      &quot;ports&quot;: {
        &quot;port&quot;: &quot;8080/http&quot;
      }
    });
    breeds.create({
      &quot;name&quot;: &quot;sava:1.1.0&quot;,
      &quot;deployable&quot;: &quot;docker://magneticio/sava:1.1.0&quot;,
      &quot;ports&quot;: {
        &quot;port&quot;: &quot;8080/http&quot;
      }
    });

    // deploy the 1.0.0 service
    var deployment = deployments.create({
      &quot;name&quot;: &quot;sava&quot;,
      &quot;gateways&quot;: {
        &quot;9050/http&quot;: &quot;sava/port&quot;
      },
      &quot;clusters&quot;: {
        &quot;sava&quot;: {
          &quot;services&quot;: [
            {
              &quot;breed&quot;: &quot;sava:1.0.0&quot;
            }
          ]
        }
      }
    });
    storage.put(&quot;deployment&quot;, deployment.name);
  } else if(stage == 1) { // deploy the 1.1.0 service
    deployments.update(storage.get(&quot;deployment&quot;), {
      &quot;name&quot;: &quot;sava&quot;,
      &quot;clusters&quot;: {
        &quot;sava&quot;: {
          &quot;services&quot;: [
            {
              &quot;breed&quot;: &quot;sava:1.1.0&quot;
            }
          ]
        }
      }
    });
  } else if(stage == 2) { // adjust weight of services
    deployments.update(storage.get(&quot;deployment&quot;), {
      &quot;name&quot;: &quot;sava&quot;,
      &quot;clusters&quot;: {
        &quot;sava&quot;: {
          &quot;services&quot;: [
            {
              &quot;breed&quot;: &quot;sava:1.0.0&quot;,
            },
            {
              &quot;breed&quot;: &quot;sava:1.1.0&quot;,
            }
          ],
          &quot;routing&quot;: {
            &quot;routes&quot;: {
              &quot;sava:1.0.0&quot;: {
                &quot;weight&quot;: &quot;0%&quot;
              },
              &quot;sava:1.1.0&quot;: {
                &quot;weight&quot;: &quot;100%&quot;
              }
            }
          }
        }
      }
    });
  } else if(stage == 3) { // delete the 1.0.0
    deployments.delete(storage.get(&quot;deployment&quot;), {
      &quot;name&quot;: &quot;sava&quot;,
      &quot;clusters&quot;: {
        &quot;sava&quot;: {
          &quot;services&quot;: [
            {
              &quot;breed&quot;: &quot;sava:1.0.0&quot;
            }
          ]
        }
      }
    });
  }
  
  storage.put(&quot;stage&quot;, ++stage);
</code></pre>

</span>


<h4 id="http-api:fb1fa01592006b281b5dab056da87dae">HTTP API</h4>

<p>Similar to <a href="https://github.com/visionmedia/superagent">superagent</a> but synchronous.</p>

<ul>
<li>set header: set(name, value)</li>
<li>set body: send(body)</li>
<li>get request: get(url)</li>
<li>post request: post(url)</li>
<li>put request: put(url)</li>
<li>delete request: delete(url)</li>
<li>get response as string (end): string()</li>
<li>get response as json (end): json()</li>
<li>reset all parameters: reset()</li>
</ul>

<pre><code class="language-yaml">name: counter-schedule
time: &quot;*/3 * * * * ?&quot;

import:
- http://underscorejs.org/underscore-min.js

storage:
  counter: 0

script: |

  var breeds = http.get(&quot;http://localhost:8080/api/v1/breeds&quot;).json();
  _.each(breeds, function(breed){ log.info(breed); });
  
  // set custom header
  http.set(&quot;Accept&quot;, &quot;application/x-yaml&quot;)
  // specify method (GET) and URL
  http.get(&quot;http://localhost:8080/api/v1/breeds&quot;)
  // retrieve YAML response
  var breeds = http.string();
  log.info(breeds);
  
</code></pre>

<h4 id="time-api:fb1fa01592006b281b5dab056da87dae">Time API</h4>

<ul>
<li>format(pattern: String): String</li>
<li>now():  <a href="https://docs.oracle.com/javase/8/docs/api/java/time/OffsetDateTime.html">OffsetDateTime</a></li>
<li>epoch() // Unix Epoch</li>
<li>timestamp() == epoch()</li>
</ul>

<pre><code class="language-javascript">  log.info(&quot;now: &quot; + time.format(&quot;dd-MM-yyyy HH:mm:SS&quot;));
</code></pre>

                <span class="pull-right muted" style="margin-top: 15px">Found an error or a typo in these docs?<a href="https://github.com/magneticio/vamp.io/tree/master/content/documentation" target="_blank"> Submit an issue or a pull request!</a></span>
   
            </div>
            <div class="col-md-1 hidden-xs hidden-sm">
            </div>
        </div>
    </div>
</section>

<footer class="footer-1">
    <div class="container">
        <div class="row links">
            <nav>
                <div class="col-sm-3">
                    <h6>Learn more</h6>
                    <ul>
                        <li><a href="http://vamp.io/documentation/">About Vamp</a></li>
                        <li><a href="http://vamp.io/quick-start/">Quick start</a></li>
                        <li><a href="http://vamp.io/documentation/using-vamp/">Using Vamp</a></li>
                        <li><a href="http://vamp.io/documentation/guides/">Guides</a></li>
                        <li><a href="http://vamp.io/documentation/api-reference/">API reference</a></li>
                        <li><a href="http://vamp.io/documentation/cli-reference/">CLI reference</a></li>
                        <li><a href="http://vamp.io/faq/">FAQ</a></li>
                    </ul>
                </div>
                <div class="col-sm-4">
                    <h6>All things code</h6>
                    <ul>
                        <li><a href="http://vamp.io/contribute/">Contribute</a></li>
                        <li><a href="http://vamp.io/documentation/community/">Issues & support</a></li>
                        <li><a href="https://github.com/magneticio/vamp/" target="_blank">Github</a></li>
                    </ul>
                </div>
                <div class="col-sm-5">
                    <h6>Stay up to date</h6>
                    <div class="subscribe-form">
                        <p class="muted subscribe-lead">Leave your email for the latest news: we won't spam you and won't go off topic.</p>
                        <form action="//magnetic.us9.list-manage.com/subscribe/post?u=c709b3ab8cce9e00d617e01b6&amp;id=c1465e21d0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate form-inline" style="display: inline" target="_blank" novalidate>
                            <div class="mc-field-group input-group">
                                <input type="email" value="" name="EMAIL" class="required email form-control" id="mce-EMAIL" placeholder="Email">
                                <span class="input-group-btn">
                                <button type="submit" value="Sign up" name="subscribe" id="mc-embedded-subscribe-2" class="btn btn-info">SIGN UP</button>
                            </span>
                            </div>
                        </form>
                    </div>
                    <p>
                        Or subscribe to our <a href="http://vamp.io/index.xml">RSS feed</a>
                    </p>
                </div>
            </nav>
        </div>
        <div class="row licensing">
            <div class="col-sm-3">
                <div class="brand hidden-xs">
                    <img src="http://vamp.io/img/magneticio_logo_gray.svg">
                </div>
            </div>
            <div class="col-sm-4">
            </div>
            <div class="col-sm-5">
                <p class="muted pull-right">
                    Code licensed under <a href="https://tldrlegal.com/license/apache-license-2.0-(apache-2.0)">Apache 2</a> © 2015 <a href="http://magnetic.io/">Magnetic.io</a>
                    <br>
                </p>
            </div>
        </div>
    </div>
</footer>
<script>
(function(i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

ga('create', 'UA-59948816-1', 'auto');
ga('send', 'pageview');
</script>
<script src="http://vamp.io/vendor/theme/common-files/js/jquery-1.10.2.min.js"></script>
<script src="http://vamp.io/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="http://vamp.io/vendor/theme/common-files/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script src="http://vamp.io/vendor/theme/common-files/js/modernizr.custom.js"></script>
<script src="http://vamp.io/vendor/theme/common-files/js/easing.min.js"></script>
<script src="http://vamp.io/vendor/theme/common-files/js/startup-kit.js"></script>
<script src="http://vamp.io/vendor/google-code-prettify/prettify.js"></script>
<script src="http://vamp.io/vendor/google-code-prettify/lang-yaml.js"></script>
<script src="http://vamp.io/vendor/google-code-prettify/lang-scala.js"></script>
<script src="http://vamp.io/vendor/prism/prism.js"></script>
<script src="http://vamp.io/js/ZeroClipboard.min.js"></script>
<script src="http://vamp.io/js/custom.js"></script>
<script>
$('document').ready(prettyPrint())
</script>
</div>
</body>

</html>